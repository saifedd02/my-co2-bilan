<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>CO₂ Express –  CSV-Tool</title>

  <!-- Font Awesome für Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  
  <!-- PapaParse für CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <!-- Chart.js für Diagramme -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
  <!-- html2pdf.js für PDF-Export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
  <!-- SheetJS für Excel-Export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    /********************************************************************
     * 1) Allgemeines Layout & Navigation
     ********************************************************************/
    * {
      margin: 0; 
      padding: 0; 
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #23d5ab, #23a6d5);
      color: #333;
      min-height: 100vh;
      padding: 1rem;
    }
    header {
      background: linear-gradient(90deg, #004d40, #00796b);
      padding: 15px 30px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: #fff;
      border-radius: 10px;
      margin-bottom: 1rem;
    }
    header img {
      height: 45px;
      transition: transform 0.3s ease;
    }
    header img:hover {
      transform: scale(1.05);
    }
    nav {
      display: flex;
      gap: 20px;
    }
    nav a {
      color: #fff;
      text-decoration: none;
      font-weight: 500;
      padding: 8px 15px;
      border-radius: 25px;
      transition: background 0.3s;
    }
    nav a:hover {
      background: rgba(165,214,167,0.2);
    }
    nav a.active {
      background: rgba(35,213,171,0.3);
    }

    /********************************************************************
     * 2) Container, Überschriften & Buttons
     ********************************************************************/
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: #fff;
      border-radius: 10px;
      padding: 2rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }
    h1.title {
      text-align: center;
      margin-bottom: 1rem;
      font-size: 1.8rem;
      color: #004d40;
    }
    p.description {
      text-align: center;
      margin-bottom: 1rem;
      color: #444;
      line-height: 1.4;
      max-width: 900px;
      margin: 0.5rem auto 1rem auto;
    }
    .btn {
      background: linear-gradient(45deg, #23d5ab, #23a6d5);
      color: #fff;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 25px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s;
      margin: 0.2rem 0;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(35,213,171,0.4);
    }
    .btn-row {
      text-align: center; 
      margin-top: 1rem;
    }
    .template-link {
      display: inline-block;
      margin: 0.5rem 0;
      color: #00796b;
      text-decoration: underline;
      cursor: pointer;
      font-size: 0.9rem;
    }

    /********************************************************************
     * 3) CSV-Bereich (mit ausführlicher Anleitung)
     ********************************************************************/
    .csv-section {
      border: 1px dashed #bbb;
      padding: 1rem;
      border-radius: 8px;
      background: #f9f9f9;
      margin-bottom: 1.5rem;
    }
    .csv-section h2 {
      font-size: 1.2rem;
      margin-bottom: 0.5rem;
      color: #333;
    }
    .csv-section p {
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 0.5rem;
    }
    .csv-section label {
      display: inline-block;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }
    .csv-help {
      background: #e8f5e9;
      border-left: 5px solid #2e7d32;
      padding: 1rem;
      border-radius: 5px;
      margin: 1rem 0;
      font-size: 0.9rem;
      color: #004d40;
    }
    #csvError {
      margin-top: 0.5rem;
      color: #b71c1c;
      font-weight: bold;
    }

    /* CSV-Preview (Debug) */
    #csvPreview {
      margin-top: 1rem;
      max-height: 250px;
      overflow-y: auto;
      font-size: 0.85rem;
    }
    #csvPreviewTable {
      width: 100%;
      border-collapse: collapse;
    }
    #csvPreviewTable th, #csvPreviewTable td {
      border: 1px solid #ccc;
      padding: 0.5rem;
    }
    #csvPreviewTable th {
      background: #eee;
      font-weight: bold;
    }

    /********************************************************************
     * 4) Dashboard
     ********************************************************************/
    #dashboard {
      display: none; /* Wird dynamisch eingeblendet */
      margin-top: 2rem;
    }
    #pdfContent {
      background: #fafafa;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 1rem;
    }
    .scope-summary {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin: 2rem 0;
    }
    .scope-box {
      flex: 1 1 200px;
      background: #f2f2f2;
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      min-width: 200px;
    }
    .scope-box h3 {
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
      color: #004d40;
    }
    .scope-box p {
      font-size: 0.9rem;
      margin: 0;
    }
    table.scope-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }
    table.scope-table th, table.scope-table td {
      border: 1px solid #ccc;
      padding: 0.5rem;
    }
    table.scope-table th {
      background: #e3f2fd;
      color: #333;
      font-weight: bold;
    }
    .chart-container {
      max-width: 500px;
      margin: 2rem auto;
    }
    .chart-container canvas {
      width: 100% !important;
      height: auto !important;
    }
    .chart-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 2rem;
      justify-content: center;
      margin-top: 2rem;
    }
    .chart-box {
      background: #f9f9f9;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      min-width: 280px;
      flex: 1 1 280px;
      text-align: center;
    }
    .chart-box h4 {
      margin-bottom: 1rem;
      font-size: 1rem;
      color: #004d40;
    }
    .dash-btns {
      text-align: center;
      margin: 1rem 0;
    }
    .dash-btns .btn {
      margin: 0 0.5rem;
    }

    /********************************************************************
     * 5) PDF / Print Zusätze
     ********************************************************************/
    @media print {
      .btn, header, .template-link, .csv-section {
        display: none !important;
      }
      body {
        background: #fff;
      }
      #pdfContent {
        border: none;
        background: #fff;
      }
    }

:root {
    --primary: #23d5ab;
    --secondary: #23a6d5;
    --dark: #004d40;
    --light: #e8f5e9;
    --glow: rgba(35, 213, 171, 0.2);
    --card: rgba(255, 255, 255, 0.95);
    --text-dark: #2c3e50;
}

body {
    margin: 0;
    min-height: 100vh;
    background: linear-gradient(-45deg, #23d5ab, #23a6d5, #23d5ab, #23a6d5);
    background-size: 400% 400%;
    animation: gradient 15s ease infinite;
    font-family: 'Arial', sans-serif;
    color: var(--text-dark);
}

@keyframes gradient {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

/* Header Styles */
header {
    background: linear-gradient(90deg, #004d40, #00796b);
    padding: 15px 30px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    position: sticky;
    top: 0;
    z-index: 1000;
    color: white;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
}

header img {
    height: 45px;
    transition: transform 0.3s ease;
}

header img:hover {
    transform: scale(1.05);
}

nav {
    display: flex;
    gap: 30px;
    align-items: center;
}

header a {
    color: white;
    text-decoration: none;
    font-size: 16px;
    font-weight: 500;
    padding: 8px 15px;
    border-radius: 25px;
    transition: all 0.3s ease;
    position: relative;
    display: flex;
    align-items: center;
    gap: 8px;
}

header a i {
    font-size: 18px;
    opacity: 0.9;
}

header a:hover {
    background: rgba(165, 214, 167, 0.15);
    color: #a5d6a7;
    transform: translateY(-2px);
}

header a::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    width: 0;
    height: 2px;
    background: #a5d6a7;
    transform: translateX(-50%);
    transition: width 0.3s ease;
}

header a:hover::after {
    width: 80%;
}

header a.active {
    background: rgba(165, 214, 167, 0.2);
    color: #a5d6a7;
}

header a[href="Dashboard.html"] {
    background: rgba(35, 213, 171, 0.15);
    border: 1px solid rgba(35, 213, 171, 0.3);
}

header a[href="Dashboard.html"]:hover {
    background: rgba(35, 213, 171, 0.25);
    border-color: rgba(35, 213, 171, 0.5);
}

@media (max-width: 768px) {
    header {
        padding: 15px 20px;
    }

    nav {
        gap: 15px;
    }

    header a {
        padding: 6px 10px;
        font-size: 14px;
    }

    header img {
        height: 35px;
    }

    @media (max-width: 480px) {
        header a span {
            display: none;
        }
        
        header a i {
            font-size: 20px;
        }
    }
}

/* Form Sections */
.form-section {
    background: var(--card);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    margin: 2rem auto;
    padding: 2rem;
    max-width: 1200px;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    transform-style: preserve-3d;
    transition: all 0.6s ease;
}

.form-section:hover {
    transform: translateY(-10px) rotateX(5deg);
}

/* Scope Sections */
.scope-section {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 15px;
    padding: 1.5rem;
    margin: 1rem 0;
    transition: all 0.3s ease;
    border: 1px solid rgba(46, 204, 113, 0.1);
}

.scope-section:hover {
    box-shadow: 0 5px 15px rgba(46, 204, 113, 0.1);
    transform: translateY(-3px);
}

/* Form Groups */
.form-group {
    margin-bottom: 1.5rem;
}

label {
    display: block;
    color: var(--text-dark);
    margin-bottom: 0.5rem;
    font-weight: 500;
}

/* Input Styles */
input, select {
    width: 100%;
    padding: 12px 20px;
    border: none;
    border-radius: 25px;
    background: rgba(255, 255, 255, 0.9);
    box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
    font-size: 16px;
    transition: all 0.3s;
}

input:focus, select:focus {
    outline: none;
    box-shadow: 
        inset 0 2px 5px rgba(0, 0, 0, 0.1),
        0 0 0 2px var(--primary);
    transform: translateY(-2px);
}

/* Buttons */
button {
    width: auto;
    padding: 12px 24px;
    border: none;
    border-radius: 25px;
    background: linear-gradient(45deg, #23d5ab, #23a6d5);
    color: white;
    font-size: 16px;
    cursor: pointer;
    transition: transform 0.3s, box-shadow 0.3s;
    position: relative;
    overflow: hidden;
}

button:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(35, 213, 171, 0.4);
}

button::after {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transform: rotate(45deg);
    animation: shine 3s infinite;
}

@keyframes shine {
    0% { transform: translateX(-100%) rotate(45deg); }
    100% { transform: translateX(100%) rotate(45deg); }
}

button[type="submit"] {
    width: 100%;
    max-width: 1200px;
    margin: 2rem auto;
    display: block;
    padding: 1rem;
    font-weight: bold;
}

.remove-field {
    
    background: linear-gradient(45deg, #ff6b6b, #ee5253);
    padding: 8px 16px;
    font-size: 14px;
}

/* Dynamic Fields */
.dynamic-field {
    background: white;
    padding: 1.5rem;
    border-radius: 15px;
    margin: 1rem 0;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
    0% { transform: translateY(0px); }
    50% { transform: translateY(-5px); }
    100% { transform: translateY(0px); }
}

/* Result Section */
.result-section {
    background: var(--card);
    border-radius: 20px;
    padding: 2rem;
    margin: 2rem auto;
    max-width: 1200px;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
}

/* Responsive Design */
@media (max-width: 768px) {
    .form-section {
        margin: 1rem;
        padding: 1.5rem;
    }
    
    .dynamic-field {
        grid-template-columns: 1fr;
    }
}

.input-toggle {
    margin-bottom: 1rem;
    margin: 15px 0;
    padding: 10px;
    background: #f9f9f9;
    border-radius: 8px;
}

.calculation-method {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.energy-price-info {
    font-size: 0.9em;
    color: #666;
    margin-top: 0.25rem;
}

.cost-input {
    background: #f5f5f5;
    padding: 15px;
    border-radius: 8px;
    margin-top: 10px;
}

.emissions-summary {
    background: #f5f5f5;
    padding: 15px;
    border-radius: 8px;
    margin-top: 20px;
}

.emissions-summary .total {
    margin-top: 10px;
    padding-top: 10px;
    border-top: 2px solid #004d40;
    font-weight: bold;
}

.tooltip-icon {
    display: inline-block;
    background: #004d40;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    text-align: center;
    font-size: 14px;
    line-height: 20px;
    margin-left: 5px;
    cursor: pointer;
    position: relative;
}

.tooltip-text {
    display: none;
    position: absolute;
    background: rgba(0,0,0,0.8);
    color: #fff;
    padding: 8px;
    border-radius: 5px;
    font-size: 14px;
    top: 25px; 
    left: 0;
    width: 200px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    z-index: 1000;
}

.tooltip-icon:hover + .tooltip-text,
.tooltip-icon:focus + .tooltip-text {
    display: block;
}

/* Chatbot Styles */
.chatbot-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 300px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 15px rgba(0,0,0,0.1);
    z-index: 1000;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.chat-header {
    background: #004d40;
    color: white;
    padding: 10px 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
}

.header-content {
    display: flex;
    align-items: center;
    gap: 8px;
}

.small-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    overflow: hidden;
    border: 1px solid rgba(255,255,255,0.3);
    flex-shrink: 0;
}

.small-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.chat-title {
    font-size: 14px;
    font-weight: bold;
}

.minimize-btn {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    font-size: 18px;
}

.chat-body {
    height: 400px;
    display: flex;
    flex-direction: column;
}

.chat-messages {
    flex-grow: 1;
    overflow-y: auto;
    padding: 10px;
    background: #f8f9fa;
}

.message {
    margin-bottom: 10px;
    padding: 8px 12px;
    border-radius: 15px;
    max-width: 80%;
}

.bot-message {
    background: #e3f2fd;
    margin-right: auto;
}

.user-message {
    background: #004d40;
    color: white;
    margin-left: auto;
}

.quick-replies {
    padding: 10px;
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
}

.quick-reply {
    background: #f0f0f0;
    border: none;
    padding: 5px 10px;
    border-radius: 15px;
    cursor: pointer;
    font-size: 12px;
}

.quick-reply:hover {
    background: #e0e0e0;
}

.chat-input {
    display: flex;
    padding: 10px;
    gap: 5px;
    border-top: 1px solid #eee;
}

.chat-input input {
    flex-grow: 1;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 20px;
    outline: none;
}

.chat-input button {
    background: #004d40;
    color: white;
    border: none;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    cursor: pointer;
}

.chatbot-container.minimized .chat-body {
    display: none;
}

/* Animiertes Icon */
.fa-leaf {
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
}
/*veränderung*/

.scope-section {
    position: relative; /* Für Pseudo-Elemente */
    margin: 1rem 0;
    padding: 1.5rem 1rem;
    background: rgba(255, 255, 255, 0.9);
    border-left: 4px solid var(--primary); /* farbiger Balken links */
    border-radius: 10px;
  }
  
  /* Optional: Kleinen "Trennstrich" zwischen Abschnitten */
  .scope-section + .scope-section::before {
    content: "";
    display: block;
    width: 50%;
    height: 2px;
    margin: 2rem auto;
    background: var(--primary);
    opacity: 0.2;
  }

  @media (max-width: 480px) {
    .dynamic-field {
      grid-template-columns: 1fr; /* Alles untereinander */
      gap: 0.5rem; /* etwas geringerer Abstand */
    }
  }
  .remove-field {
  background: linear-gradient(45deg, #ff6b6b, #ee5253);
  padding: 8px 16px;
  font-size: 14px;
  border: none;
  border-radius: 25px;
}
.remove-field:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
}

button {
    background: linear-gradient(45deg, var(--primary), var(--secondary));
    color: #fff;
    border: none;
    border-radius: 25px;
    padding: 10px 20px;
    cursor: pointer;
    transition: transform 0.3s;
    font-size: 14px;
}

button:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(35, 213, 171, 0.4);
}

/* Entfernen-Button in Rot */
button.remove-button {
    background: linear-gradient(45deg, #ff6b6b, #ee5253);
}

/* Größerer Submit-Button */
button.submit-button {
    width: 100%;
    max-width: 1200px;
    display: block;
    margin: 2rem auto;
    font-size: 16px;
    font-weight: bold;
    padding: 1rem;
}
.add-button {
    background: linear-gradient(45deg, #4caf50, #2ecc71); /* z.B. Grüner Ton */
    margin-bottom: 1rem;
    color: #fff;
}

/* Wenn du noch Hover-Effekt willst: */
.add-button:hover {
    box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
}

.scope-card {
    background: #ffffff; /* oder var(--card), wenn du möchtest */
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }

  /* Farbige Hintergründe für unterschiedliche Scopes */

/* Scope 1 mit leichtem Grünhauch */
.scope-1 {
    background: #ecfdf5; /* helles Grün */
    border-left: 5px solid #23d5ab; /* auffälliger Balken links */
    margin-bottom: 2rem; 
    padding: 1.5rem;
    border-radius: 8px;
  }
  
  /* Scope 2 mit hellblauer Tönung */
  .scope-2 {
    background: #f0f9ff; /* helles Blau */
    border-left: 5px solid #23a6d5;
    margin-bottom: 2rem; 
    padding: 1.5rem;
    border-radius: 8px;
  }
  
  /* Scope 3 mit gelblicher Nuance */
  .scope-3 {
    background: #fffbeb; /* helles Gelb */
    border-left: 5px solid #fcd34d;
    margin-bottom: 2rem; 
    padding: 1.5rem;
    border-radius: 8px;
  }
  /* =========================
   1) Grundlegende Variablen
   ========================= */
:root {
    --bg-color: #1b1b1b;        /* Sehr dunkles Grau (fast Schwarz) */
    --accent-color: #00ffd5;    /* Neon-Türkis */
    --accent-color-2: #ff00ff;  /* Neon-Pink */
    --text-color: #ffffff;      /* Weißer Text */
    --text-color-light: #d1d1d1;/* Etwas hellerer Grauton für Labels */
    --header-height: 60px;
    --transition-speed: 0.3s;
  }
  
  /* =========================
     2) Allgemeines Layout
     ========================= */
  body {
    margin: 0;
    font-family: "Arial", sans-serif;
    background: var(--bg-color);
    color: var(--text-color);
    /* Kleiner animierter BG-Farbverlauf (subtil) */
    background: radial-gradient(circle at center, #222 0%, #000 100%);
    background-size: cover;
    transition: background var(--transition-speed) ease;
    overflow-x: hidden;
  }
  
  /* Sanftes "rein-zoomen" */
  @keyframes fadeInZoom {
    0% {
      opacity: 0;
      transform: scale(0.95);
    }
    100% {
      opacity: 1;
      transform: scale(1);
    }
  }
  
  /* =========================
     3) Header / Navigation
     ========================= */
  header {
    position: sticky;
    top: 0;
    z-index: 1000;
    height: var(--header-height);
    background: #111;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 1.5rem;
    box-shadow: 0 2px 8px rgba(0, 255, 213, 0.1);
    border-bottom: 1px solid rgba(0, 255, 213, 0.2);
  }
  
  header img {
    height: 40px;
    transition: transform 0.2s;
  }
  
  header img:hover {
    transform: scale(1.05);
  }
  
  nav {
    display: flex;
    gap: 15px;
  }
  
  header a {
    color: var(--accent-color);
    text-decoration: none;
    padding: 6px 12px;
    border-radius: 4px;
    font-weight: 500;
    transition: all 0.2s ease;
    position: relative;
  }
  
  header a:hover {
    background: rgba(0,255,213,0.1);
    transform: translateY(-2px);
  }
  
  header a.active {
    background: rgba(0,255,213,0.2);
    color: #fff;
    border: 1px solid rgba(0,255,213,0.3);
  }
  
  /* Responsive Header-Anpassung */
  @media (max-width: 768px) {
    nav {
      gap: 10px;
    }
    header a {
      padding: 4px 8px;
      font-size: 14px;
    }
  }
  
  /* =========================
     4) Container & Karten
     ========================= */
  .container {
    max-width: 1200px;
    margin: 1.5rem auto;
    padding: 1.5rem;
    animation: fadeInZoom 0.5s ease forwards;
  }
  
  .form-section,
  .scope-section,
  .scope-card {
    background: #2a2a2a; /* Dunkles Grau */
    border: 1px solid rgba(0,255,213,0.2);
    border-radius: 8px;
    margin-bottom: 1rem;
    padding: 1.5rem;
    box-shadow: 0 0 10px rgba(0,255,213,0.05);
    animation: fadeInZoom 0.6s ease forwards;
  }
  
  /* "Leuchtender" Rahmen bei Hover */
  .form-section:hover,
  .scope-section:hover,
  .scope-card:hover {
    box-shadow: 0 0 10px rgba(0,255,213,0.3), 0 0 20px rgba(255,0,255,0.1);
    transform: translateY(-2px);
  }
  
  /* =========================
     5) Überschriften
     ========================= */
  h1, h2, h3 {
    margin-top: 0;
    color: var(--accent-color);
    text-shadow: 0 0 5px rgba(0,255,213,0.4);
  }
  
  h1 {
    text-align: center;
    font-size: 2rem;
    margin-bottom: 1rem;
    color: var(--accent-color-2);
    text-shadow: 0 0 5px rgba(255,0,255,0.5);
  }
  
  /* =========================
     6) Formularelemente
     ========================= */
  .form-group {
    margin-bottom: 1rem;
  }
  
  label {
    display: block;
    margin-bottom: 0.3rem;
    color: var(--text-color-light);
  }
  
  input, select {
    width: 100%;
    padding: 10px 14px;
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 6px;
    background: #333;
    color: #fff;
    transition: box-shadow var(--transition-speed);
  }
  
  input:focus, select:focus {
    outline: none;
    box-shadow: 0 0 0 2px var(--accent-color);
  }
  
  /* =========================
     7) Buttons
     ========================= */
  button, .action-button {
    display: inline-block;
    background: var(--accent-color);
    color: #000;
    border: none;
    border-radius: 6px;
    padding: 10px 14px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-transform: uppercase;
    font-weight: bold;
    margin-top: 0.5rem;
  }
  
  button:hover, .action-button:hover {
    background: var(--accent-color-2);
    color: #fff;
    box-shadow: 0 0 8px var(--accent-color-2);
    transform: translateY(-2px);
  }
  
  button.submit-button {
    width: 100%;
    margin-top: 1.5rem;
    font-size: 16px;
    background: var(--accent-color-2);
    color: #fff;
  }
  
  button.remove-field {
    background: #ff0066; /* Kräftiges Pink/Rot */
    margin-top: 1rem;
  }
  
  button.remove-field:hover {
    box-shadow: 0 0 10px #ff0066;
  }
  
  /* =========================
     8) Dynamische Felder
     ========================= */
  .dynamic-fields, .dynamic-field {
    margin-top: 1rem;
    background: #333;
    border: 1px solid rgba(0,255,213,0.1);
    border-radius: 6px;
    padding: 1rem;
    position: relative;
    transition: box-shadow 0.3s;
  }
  
  .dynamic-field:hover {
    box-shadow: 0 0 8px rgba(0,255,213,0.3);
  }
  
  /* Felder in Grid-Layout */
  .dynamic-field {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1rem;
  }
  
  /* =========================
     9) Chatbot
     ========================= */
  .chatbot-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 320px;
    background: #2a2a2a;
    border: 1px solid rgba(0,255,213,0.3);
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,255,213,0.2);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    z-index: 999;
    animation: fadeInZoom 0.5s ease forwards;
  }
  
  .chat-header {
    background: #333;
    color: #fff;
    padding: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  
  .chat-header .chat-title {
    font-weight: bold;
    font-size: 14px;
  }
  
  .chat-body {
    display: flex;
    flex-direction: column;
    height: 380px;
    background: #1b1b1b;
  }
  
  .chat-messages {
    flex-grow: 1;
    overflow-y: auto;
    padding: 10px;
  }
  
  .message {
    margin-bottom: 8px;
    padding: 8px 10px;
    border-radius: 12px;
    max-width: 80%;
    line-height: 1.3;
  }
  
  .bot-message {
    background: #004d40;
    color: #fff;
    margin-right: auto;
    box-shadow: 0 0 5px rgba(0,255,213,0.3);
  }
  
  .user-message {
    background: var(--accent-color);
    color: #000;
    margin-left: auto;
    box-shadow: 0 0 5px var(--accent-color);
  }
  
  .quick-replies {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    background: #222;
    padding: 6px;
  }
  
  .quick-reply {
    background: #444;
    color: #fff;
    border: none;
    border-radius: 12px;
    padding: 5px 10px;
    font-size: 12px;
    cursor: pointer;
  }
  
  .quick-reply:hover {
    background: var(--accent-color);
    color: #000;
  }
  
  .chat-input {
    display: flex;
    gap: 5px;
    padding: 8px;
    background: #333;
  }
  
  .chat-input input {
    flex-grow: 1;
    background: #222;
    color: #fff;
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 4px;
    padding: 8px;
  }
  
  .chat-input input:focus {
    outline: none;
    box-shadow: 0 0 0 2px var(--accent-color);
  }
  
  .chat-input button {
    background: var(--accent-color);
    color: #000;
    border-radius: 4px;
    width: 40px;
    border: none;
    font-weight: bold;
  }
  
  .chatbot-container.minimized .chat-body {
    display: none;
  }
  
  /* =========================
     10) Medienabfragen
     ========================= */
  @media (max-width: 768px) {
    .container {
      margin: 1rem;
      padding: 1rem;
    }
    .dynamic-field {
      grid-template-columns: 1fr;
    }
    .chatbot-container {
      width: 90%;
      right: 5%;
    }
  }
  
  /* Kleiner Schimmer-Effekt */
  @keyframes shimmer {
    0% { background-position: -200px 0; }
    100% { background-position: 200px 0; }
  }
  /* =============================
   1) Standard-Variablen (Light Mode)
   ============================= */
:root {
    --transition-speed: 0.3s;
    --font-family: "Arial", sans-serif;
  
    /* Farben Light Mode */
    --bg-color: #f0f0f0;         /* Hintergrund (hell) */
    --text-color: #1b1b1b;       /* Text (dunkel) */
    --accent-color: #0066cc;     /* Akzent (Blau) */
    --accent-color-2: #00cc66;   /* 2. Akzent (Grün) */
    --card-bg: #ffffff;          /* Karten/Box-Hintergrund */
    --border-color: rgba(0,0,0,0.1);
  
    /* Optional: Größere Layout-Variablen */
    --header-height: 60px;
  }
  
  /* =============================
     2) Dark Mode Variablen
     Überschreiben dieselben Namen
     ============================= */
  .dark-mode {
    --bg-color: #1b1b1b;         /* Hintergrund (dunkel) */
    --text-color: #ffffff;       /* Text (hell) */
    --accent-color: #00ffd5;     /* Neon-Türkis */
    --accent-color-2: #ff00ff;   /* Neon-Pink */
    --card-bg: #2a2a2a;          /* Kartenhintergrund (dunkler) */
    --border-color: rgba(0,255,213,0.3);
  }
  
  /* =============================
     3) Globales Styling
     (greift auf die Variablen zu)
     ============================= */
  
  /* Body */
  body {
    margin: 0;
    padding: 0;
    font-family: var(--font-family);
    background: var(--bg-color);
    color: var(--text-color);
    transition: background var(--transition-speed), color var(--transition-speed);
  }
  
  /* Header (Beispiel) */
  header {
    height: var(--header-height);
    background: var(--card-bg);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 1rem;
    position: sticky;
    top: 0;
    z-index: 1000;
  }
  
  /* Ein Button, um den Mode zu toggeln */
  .toggle-btn {
    background: var(--accent-color);
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 8px 12px;
    cursor: pointer;
    transition: background var(--transition-speed);
  }
  .toggle-btn:hover {
    background: var(--accent-color-2);
  }
  
  /* Beispiel: Container / Section / Card */
  .container,
  .form-section,
  .scope-section,
  .scope-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    margin: 1rem auto;
    padding: 1rem;
    max-width: 1200px;
    transition: background var(--transition-speed), box-shadow var(--transition-speed);
  }
  
  /* Buttons allgemein */
  button, .action-button {
    background: var(--accent-color);
    color: #fff;
    border: none;
    border-radius: 25px;
    padding: 10px 20px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.2s ease;
    margin: 0.25rem 0;
  }
  button:hover, .action-button:hover {
    background: var(--accent-color-2);
  }
  
  /* Textfelder, Inputs, Selects */
  input, select, textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background: var(--card-bg);
    color: var(--text-color);
    transition: background var(--transition-speed), color var(--transition-speed);
  }
  input:focus, select:focus, textarea:focus {
    outline: 2px solid var(--accent-color);
  }
  
  /* Überschriften */
  h1, h2, h3, h4 {
    color: var(--text-color);
    margin: 0.5rem 0;
  }
  
  /* Beispiel: Minimale Chatbot-Stile (vereinfacht) */
  .chatbot-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 300px;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    box-shadow: 0 2px 15px rgba(0,0,0,0.1);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    transition: background var(--transition-speed);
  }
  .chat-header {
    background: var(--accent-color);
    color: #fff;
    padding: 10px;
    cursor: pointer;
  }
  .chat-body {
    height: 400px;
    overflow-y: auto;
    padding: 10px;
    background: var(--card-bg);
  }
  .message {
    background: #e3f2fd;
    margin: 5px 0;
    padding: 8px;
    border-radius: 8px;
  }
  
  /* etc. … */
  /* ==============================================
   1) Standard (Light Mode) – Variablen & Basics
   ============================================== */
:root {
    --transition-speed: 0.3s;
    --font-family: 'Arial', sans-serif;
  
    /* Farben: Light Mode */
    --bg-color: #f8f8f8;        /* Hintergrund hell */
    --text-color: #2c3e50;      /* Dunkler Text */
    --accent-color: #0066cc;    /* Akzent (Blau) */
    --accent-color-2: #00cc66;  /* 2. Akzent (Grün) */
    --card-bg: #ffffff;         /* Karten / Boxen */
    --border-color: rgba(0,0,0,0.1);
  
    /* Layout-Größen */
    --header-height: 60px;
  }
  
  /* ==============================================
     2) Dark Mode – überschreibt dieselben Variablen
     ============================================== */
  .dark-mode {
    --bg-color: #1b1b1b;        /* Sehr dunkel */
    --text-color: #ffffff;      /* Heller Text */
    --accent-color: #00ffd5;    /* Neon-Türkis */
    --accent-color-2: #ff00ff;  /* Neon-Pink */
    --card-bg: #2a2a2a;         /* Dunkles Grau */
    --border-color: rgba(0,255,213,0.3);
  }
  
  /* ==============================================
     3) Globales Styling
     ============================================== */
  body {
    margin: 0;
    padding: 0;
    font-family: var(--font-family);
    background: var(--bg-color);
    color: var(--text-color);
    transition: background var(--transition-speed), color var(--transition-speed);
  }
  
  /* Header-Beispiel */
  header {
    height: var(--header-height);
    background: var(--card-bg);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 1rem;
    position: sticky;
    top: 0;
    z-index: 1000;
  }
  
  header img {
    height: 40px;
    transition: transform 0.2s;
  }
  header img:hover {
    transform: scale(1.05);
  }
  
  /* Navigation */
  nav {
    display: flex;
    gap: 15px;
  }
  
  header a {
    color: var(--accent-color);
    text-decoration: none;
    padding: 6px 12px;
    border-radius: 25px;
    font-weight: 500;
    transition: all 0.2s ease;
    position: relative;
  }
  header a:hover {
    background: rgba(0, 0, 0, 0.05);
    transform: translateY(-2px);
  }
  header a.active {
    background: rgba(0, 0, 0, 0.1);
    color: var(--text-color);
  }
  
  /* ==============================================
     4) Container, Sektionen, Karten
     ============================================== */
  .container,
  .form-section,
  .scope-section,
  .scope-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    margin: 1rem auto;
    padding: 1rem;
    max-width: 1200px;
    transition: background var(--transition-speed), box-shadow var(--transition-speed);
  }
  
  /* Hover-Effekt bei Cards/Sektionen */
  .form-section:hover,
  .scope-section:hover,
  .scope-card:hover {
    box-shadow: 0 2px 8px var(--border-color);
    transform: translateY(-2px);
  }
  
  /* ==============================================
     5) Überschriften
     ============================================== */
  h1, h2, h3, h4 {
    color: var(--accent-color);
    margin: 0.5rem 0;
  }
  h1 {
    text-align: center;
    font-size: 1.8rem;
    color: var(--accent-color-2);
    margin-bottom: 1rem;
  }
  
  /* ==============================================
     6) Formularelemente
     ============================================== */
  .form-group {
    margin-bottom: 1rem;
  }
  label {
    display: block;
    margin-bottom: 0.3rem;
    font-weight: bold;
    color: var(--text-color);
  }
  input, select, textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background: var(--bg-color);
    color: var(--text-color);
    transition: background var(--transition-speed), color var(--transition-speed);
  }
  input:focus, select:focus, textarea:focus {
    outline: 2px solid var(--accent-color);
  }
  
  /* ==============================================
     7) Buttons
     ============================================== */
  button, .action-button {
    background: var(--accent-color);
    color: #fff;
    border: none;
    border-radius: 25px;
    padding: 10px 20px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.2s ease;
    margin: 0.25rem 0;
  }
  button:hover, .action-button:hover {
    background: var(--accent-color-2);
    transform: translateY(-2px);
  }
  button.submit-button {
    width: 100%;
    margin-top: 1.5rem;
    font-size: 16px;
    background: var(--accent-color-2);
  }
  
  /* Entfernen-Button in Rot */
  button.remove-field {
    background: #ff0066;
    margin-top: 1rem;
  }
  button.remove-field:hover {
    box-shadow: 0 0 10px #ff0066;
  }
  
  /* ==============================================
     8) Dynamische Felder (z.B. .dynamic-field)
     ============================================== */
  .dynamic-fields,
  .dynamic-field {
    margin-top: 1rem;
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 1rem;
    position: relative;
    transition: box-shadow 0.3s;
  }
  
  .dynamic-field {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1rem;
  }
  .dynamic-field:hover {
    box-shadow: 0 0 8px var(--border-color);
  }
  
  /* ==============================================
     9) Quick-Replies / Chatbot-Elemente
     ============================================== */
  .quick-reply {
    background: var(--card-bg);
    color: var(--text-color);
    border: 1px solid var(--border-color);
    border-radius: 15px;
    padding: 5px 10px;
    font-size: 12px;
    cursor: pointer;
  }
  .quick-reply:hover {
    background: var(--accent-color);
    color: #fff;
  }
  
  /* ==============================================
     10) Chatbot-Container
     ============================================== */
  .chatbot-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 320px;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    box-shadow: 0 2px 15px rgba(0,0,0,0.1);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    transition: background var(--transition-speed);
  }
  
  .chat-header {
    background: var(--accent-color);
    color: #fff;
    padding: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  
  .chat-body {
    height: 400px;
    overflow-y: auto;
    padding: 10px;
    background: var(--bg-color);
  }
  
  .chat-messages {
    flex-grow: 1;
    overflow-y: auto;
    padding: 10px;
  }
  
  .message {
    margin-bottom: 8px;
    padding: 8px 10px;
    border-radius: 12px;
    max-width: 80%;
    line-height: 1.3;
    color: var(--text-color);
    background: var(--card-bg);
    border: 1px solid var(--border-color);
  }
  
  .bot-message {
    margin-right: auto;
    border-left: 3px solid var(--accent-color);
  }
  .user-message {
    margin-left: auto;
    border-left: 3px solid var(--accent-color-2);
  }
  
  .chat-input {
    display: flex;
    gap: 5px;
    padding: 8px;
    background: var(--card-bg);
    border-top: 1px solid var(--border-color);
  }
  
  .chat-input input {
    flex-grow: 1;
    background: var(--bg-color);
    color: var(--text-color);
    border: 1px solid var(--border-color);
    border-radius: 25px;
    padding: 8px;
  }
  .chat-input button {
    background: var(--accent-color);
    color: #fff;
    border-radius: 25px;
    width: 40px;
    border: none;
    font-weight: bold;
    cursor: pointer;
  }
  
  .chatbot-container.minimized .chat-body {
    display: none;
  }
  
  /* ==============================================
     11) Responsive Anpassungen
     ============================================== */
  @media (max-width: 768px) {
    .container {
      margin: 1rem;
      padding: 1rem;
    }
    .dynamic-field {
      grid-template-columns: 1fr;
    }
    .chatbot-container {
      width: 90%;
      right: 5%;
    }
  }
  ::-webkit-input-placeholder { 
    color: rgba(255,255,255,0.5); /* z.B. in Dark Mode */
  }
  :-ms-input-placeholder {
    color: rgba(255,255,255,0.5);
  }
  ::placeholder {
    color: rgba(255,255,255,0.5);
  }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header style="min-height: 130px; padding: 15px 30px; display: flex; align-items: center; justify-content: space-between;">
    <a href="Dateipload.html">
        <img src="logo.png" 
            alt="DigiGreen Pilot Logo" 
            style="height: 120px; width: auto; transition: transform 0.3s ease; margin: 10px 0;">
    </a>
    <nav style="margin-left: 20px;">
        <a href="Dateipload.html">
            <i class="fas fa-poll"></i> Umfrage
        </a>
        <a href="Co2express.html" class="active">
            <i class="fas fa-bolt"></i> CO₂ Express
        </a>
        <a href="Chatbot.html">
            <i class="fas fa-comments"></i> Chatbot
        </a>
        <a href="livecalc.html" >
            <i class="fas fa-calculator"></i> Live Calculator
        </a>
        <a href="Dashboard.html">
            <i class="fas fa-leaf"></i> Dashboard
        </a>
        <a href="https://moodle.digitalekompetenzen.org/login/index.php#module-483">
            <i class="fas fa-envelope"></i> Lernplatform
        </a>
        <a href="Meinprofil.html">
            <i class="fas fa-user"></i> Mein Profil
        </a>
    </nav>
    <button class="toggle-btn" onclick="toggleMode()" style="margin-left: 20px;">Mode wechseln</button>
</header>


  <!-- HAUPT-CONTAINER -->
  <div class="container" style="margin-top: -10px;">
    <h1 class="title">CO₂ Express – Umfangreiches CSV-Tool</h1>
    <p class="description">
        Willkommen bei Ihrem umfangreichen CO₂-Express-Tool. Laden Sie unser vorbereitetes
        CSV-Template herunter, füllen Sie die Tabellenzeilen in Excel oder Google Sheets
        (inkl. Ihrer Emissionsfaktoren, Mengen etc.) und laden Sie die Datei anschließend
        wieder hoch. Das Tool erstellt automatisch ein Dashboard mit Diagrammen und bietet
        PDF- und Excel-Export an.
    </p>

    <!-- CSV-Bereich -->
    <div class="csv-section">
      <h2>1) CSV-Template herunterladen</h2>
      <p>Dieses Template enthält bereits Beispielzeilen für Scope 1, 2 und 3 sowie Sub-Kategorien (z.B. <code>3B_postal</code>). Öffnen Sie die Datei in Excel, ergänzen oder überschreiben Sie die Daten, und speichern Sie erneut als CSV.</p>
      <button class="btn" onclick="downloadTemplate()">CSV-Template herunterladen</button>

      <div class="csv-help">
        <strong>Was tun bei Formatierungen oder Farben?</strong><br>
        CSV-Dateien unterstützen leider keine Farb- oder Tabellenformatierungen. Wenn Sie in Excel Farben/Bedingte Formatierungen anlegen, werden diese in der CSV nicht gespeichert. Die Daten bleiben jedoch erhalten. 
      </div>

      <hr style="margin:1rem 0;">

      <h2>2) Ausgefüllte CSV hochladen</h2>
      <label for="csvFileInput">Datei wählen (CSV, UTF-8):</label><br>
      <input type="file" id="csvFileInput" accept=".csv">
      <p class="info-msg">
        <strong>Hinweis:</strong> Das CSV muss mindestens die Spalte <code>scope</code> enthalten. Weitere Spalten (z.B. <code>emissionFactor</code>, <code>quantity</code>, <code>co2Emissions</code>) siehe Template.
      </p>
      <div id="csvError"></div>

      <div class="btn-row">
        <button class="btn" onclick="processCSV()">CSV verarbeiten</button>
      </div>

      <!-- CSV-Preview (Debug) -->
      <div id="csvPreview"></div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard">
      <div id="pdfContent">
        <h2>CO₂-Bilanz Ergebnis</h2>
        <p id="companyInfo" style="font-size:0.9rem;color:#444;"></p>

        <!-- Summen pro Scope (kleine Boxen) -->
        <div class="scope-summary" id="scopeSummary"></div>

        <!-- Tabelle (Scope-Übersicht) -->
        <table class="scope-table" id="scopeTable">
          <thead>
            <tr>
              <th>Scope</th>
              <th>Emissionen (kg CO₂)</th>
              <th>Anteil (%)</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <th>Gesamt</th>
              <th id="totalEmissionCell"></th>
              <th>100%</th>
            </tr>
          </tfoot>
        </table>

        <!-- Diagramm: Doughnut (Scope-Verteilung) -->
        <div class="chart-container">
          <canvas id="scopeChart"></canvas>
        </div>

        <!-- Subscope-Diagramm: Balken pro Subscope -->
        <div class="chart-grid">
          <div class="chart-box">
            <h4>Subscope-Emissionen</h4>
            <canvas id="subscopeChart"></canvas>
          </div>
        </div>
      </div>

      <div class="dash-btns">
        <button class="btn" onclick="toggleSubscopeChartType()">Chart-Typ wechseln</button>
        <button class="btn" onclick="downloadPDF()">PDF Export</button>
        <button class="btn" onclick="downloadExcel()">Excel Export</button>
      </div>
    </div>

  </div> <!-- Ende container -->

  <script>
  /* ####################################################################
   * (A) CSV-TEMPLATE ZUM DOWNLOAD
   * #################################################################### */
  /**
 * downloadTemplate()
 *
 * Diese Funktion erzeugt eine CSV-Datei mit UTF-8-Kodierung und
 * lädt sie als "co2_express_template.csv" herunter. Die Datei
 * enthält die Spalten aus deinem Screenshot und die Beispiel-Daten
 * für Scope 1, 2 und 3.
 */
/**
 * downloadTemplate()
 *
 * Diese Funktion erstellt ein CSV-Template mit den Spalten:
 *   scope, subCategory, activityName, emissionFactor, quantity, unit,
 *   co2Emissions, companyName, year
 * 
 * Sie enthält Beispielzeilen für Scope 1, 2 und 3 (1A–1E, 2A–2B, 3A–3L),
 * so wie in deinem Excel-Screenshot. Das UTF-8-BOM (Byte Order Mark) wird
 * hinzugefügt, damit Excel die Datei korrekt erkennt.
 */
/**
 * downloadTemplate()
 *
 * Erstellt ein umfangreiches CSV-Template mit folgenden Spalten:
 *   scope, subCategory, activityName, description, emissionFactor, quantity, unit,
 *   co2Emissions, companyName, year, notes, cost, supplier, location, invoiceNumber
 *
 * Für jeden Scope (1A, 1B, 1C, 1D, 1E, 2A, 2B, 3A–3L) gibt es eine Beispielzeile.
 * Der Nutzer kann diese Felder in Excel/Google Sheets ausfüllen und später als CSV
 * wieder hochladen.
 */
 /**
 * downloadTemplate()
 *
 * Erstellt eine CSV-Datei mit Semikolon als Spaltentrenner, damit Excel
 * (in einer deutschsprachigen Umgebung) die Daten automatisch in mehrere
 * Spalten aufteilt. Enthält Beispielzeilen für Scope 1A–1E, 2A–2B und 3A–3L.
 * Alle Spalten sind in doppelte Anführungszeichen eingeschlossen.
 */
function downloadTemplate() {
  try {
    const BOM = "\uFEFF";

    const csvContent = BOM +
`# CO2 Express – Scope 1 Template (mit Semikolon)
# Bitte jede Zeile mit Werten füllen. 
# Wichtig: "scope" ist Pflicht. Weitere empfohlene Spalten: subCategory, activityName, emissionFactor, quantity, unit, co2Emissions, companyName, year
#
# SCOPE 1A - FAHRZEUGE & KRAFTSTOFFE
"scope";"subCategory";"activityName";"emissionFactor";"quantity";"unit";"co2Emissions";"companyName";"year"
"1A";"Kraftstoff";"Benzin";"2.32";"0";"Liter";"";"Firma";"2024"
"1A";"Kraftstoff";"Diesel";"2.65";"0";"Liter";"";"Firma";"2024"
"1A";"Kraftstoff";"Erdgas (CNG)";"2.27";"0";"kg";"";"Firma";"2024"
"1A";"Kraftstoff";"LPG";"1.63";"0";"Liter";"";"Firma";"2024"
"1A";"PKW";"PKW-Benzin-klein";"0.18";"0";"km";"";"Firma";"2024"
"1A";"PKW";"PKW-Benzin-mittel";"0.20";"0";"km";"";"Firma";"2024"
"1A";"PKW";"PKW-Benzin-groß";"0.22";"0";"km";"";"Firma";"2024"
"1A";"PKW";"PKW-Diesel-klein";"0.19";"0";"km";"";"Firma";"2024"
"1A";"PKW";"PKW-Diesel-mittel";"0.21";"0";"km";"";"Firma";"2024"
"1A";"PKW";"PKW-Diesel-groß";"0.24";"0";"km";"";"Firma";"2024"
"1A";"Alternative";"Hybrid";"0.20716";"0";"km";"";"Firma";"2024"
"1A";"Alternative";"Vollstromer";"0.18";"0";"kWh/Km";"";"Firma";"2024"

# SCOPE 1B - FIRMENEIGENE TRANSPORTER
"1B";"LKW";"LKW Diesel (3,5-7,5 Tonnen)";"0.12955";"0";"km";"";"Firma";"2024"
"1B";"LKW";"LKW Diesel (7,5-12 Tonnen)";"0.09367";"0";"km";"";"Firma";"2024"
"1B";"LKW";"LKW Diesel (> 12 Tonnen)";"0.04735";"0";"km";"";"Firma";"2024"
"1B";"LKW";"LKW Otto-CNG (3,5-7,5 Tonnen)";"0.092";"0";"km";"";"Firma";"2024"
"1B";"LKW";"LKW Otto-CNG (7,5-12 Tonnen)";"0.078";"0";"km";"";"Firma";"2024"

# SCOPE 1C - ENERGIETRÄGER & HEIZUNG
"1C";"Heizung";"Altöl (EEW) 2022";"3.15";"0";"Liter";"";"Firma";"2024"
"1C";"Heizung";"Biodiesel (EEW)";"2.70";"0";"Liter";"";"Firma";"2024"
"1C";"Heizung";"Bioethanol (EEW)";"1.90";"0";"Liter";"";"Firma";"2024"
"1C";"Heizung";"Biogas (EEW)";"0.20";"0";"kWh";"";"Firma";"2024"
"1C";"Heizung";"Biomasse Holz (EEW)";"0.028";"0";"kg";"";"Firma";"2024"
"1C";"Heizung";"Braunkohle (EEW)";"0.38";"0";"kg";"";"Firma";"2024"
"1C";"Heizung";"Erdgas Heizwert (EEW) 2022";"0.201";"0";"kWh";"";"Firma";"2024"
"1C";"Heizung";"Heizöl (HEL)";"3.11";"0";"Liter";"";"Firma";"2024"
"1C";"Heizung";"Holz-Pellets (2023)";"0.035";"0";"kg";"";"Firma";"2024"

# SCOPE 1D - TECHNISCHE GASE
"1D";"Kältemittel";"R134a";"1430";"0";"kg";"";"Firma";"2024"
"1D";"Kältemittel";"R32";"675";"0";"kg";"";"Firma";"2024"
"1D";"Kältemittel";"R404A";"3922";"0";"kg";"";"Firma";"2024"
"1D";"Kältemittel";"R407C";"1774";"0";"kg";"";"Firma";"2024"
"1D";"Kältemittel";"R410A";"2088";"0";"kg";"";"Firma";"2024"
"1D";"Industriegas";"Helium (He) (EEW) 2024";"8.60";"0";"kg";"";"Firma";"2024"
"1D";"Industriegas";"Methan (CH4)";"28.0";"0";"kg";"";"Firma";"2024"
"1D";"Industriegas";"SF6";"22800";"0";"kg";"";"Firma";"2024"
"1D";"Industriegas";"NF3";"17200";"0";"kg";"";"Firma";"2024"
"1D";"Industriegas";"Sauerstoff (O2)";"0.15";"0";"kg";"";"Firma";"2024"
"1D";"Industriegas";"Stickstoff (N2)";"0.20";"0";"kg";"";"Firma";"2024"

# SCOPE 1E - SONSTIGE EMITTENTEN
"1E";"Sonstige";"Notstromaggregat Diesel";"2.65";"0";"Liter";"";"Firma";"2024"
"1E";"Sonstige";"Andere Emissionsquelle";"0";"0";"kg";"";"Firma";"2024"
`;

    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = "co2_express_scope1_template.csv";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);

  } catch (error) {
    console.error("Fehler beim Erstellen des CSV-Templates:", error);
    alert("Beim Download des CSV-Templates ist ein Fehler aufgetreten.");
  }
}

  /* ####################################################################
   * (B) CSV einlesen und validieren
   * #################################################################### */
  let parsedData = [];

  function processCSV() {
    const fileInput = document.getElementById('csvFileInput');
    const errorEl = document.getElementById('csvError');
    errorEl.style.display = 'none';
    errorEl.textContent = '';

    if (!fileInput.files || fileInput.files.length === 0) {
      errorEl.textContent = 'Bitte eine CSV-Datei auswählen.';
      return;
    }

    const file = fileInput.files[0];
    Papa.parse(file, {
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true,
      complete: function(results) {
        if (results.errors && results.errors.length > 0) {
          errorEl.textContent = 'CSV-Fehler: ' + results.errors[0].message;
          return;
        }
        
        // Daten nach Scope gruppieren
        const scope1Data = {
          vehicles: [], // 1A
          transport1B: [], // 1B
          scope1C: [], // 1C
          scope1D: [], // 1D
          scope1DOther: [] // 1E
        };

        // Daten verarbeiten
        results.data.forEach(row => {
          if (!row.scope) return;
          
          // Emissionen berechnen falls nicht angegeben
          if (!row.co2Emissions && row.quantity && row.emissionFactor) {
            row.co2Emissions = parseFloat(row.quantity) * parseFloat(row.emissionFactor);
          }

          // Nach Scope sortieren
          switch(row.scope.trim().toUpperCase()) {
            case '1A':
              scope1Data.vehicles.push({
                activityName: row.activityName,
                quantity: parseFloat(row.quantity) || 0,
                unit: row.unit,
                emissionFactor: parseFloat(row.emissionFactor) || 0,
                co2Emissions: parseFloat(row.co2Emissions) || 0,
                subCategory: row.subCategory
              });
              break;
            case '1B':
              scope1Data.transport1B.push({
                activityName: row.activityName,
                quantity: parseFloat(row.quantity) || 0,
                unit: row.unit,
                emissionFactor: parseFloat(row.emissionFactor) || 0,
                co2Emissions: parseFloat(row.co2Emissions) || 0,
                subCategory: row.subCategory
              });
              break;
            case '1C':
              scope1Data.scope1C.push({
                activityName: row.activityName,
                quantity: parseFloat(row.quantity) || 0,
                unit: row.unit,
                emissionFactor: parseFloat(row.emissionFactor) || 0,
                co2Emissions: parseFloat(row.co2Emissions) || 0,
                subCategory: row.subCategory
              });
              break;
            case '1D':
              scope1Data.scope1D.push({
                activityName: row.activityName,
                quantity: parseFloat(row.quantity) || 0,
                unit: row.unit,
                emissionFactor: parseFloat(row.emissionFactor) || 0,
                co2Emissions: parseFloat(row.co2Emissions) || 0,
                subCategory: row.subCategory
              });
              break;
            case '1E':
              scope1Data.scope1DOther.push({
                activityName: row.activityName,
                quantity: parseFloat(row.quantity) || 0,
                unit: row.unit,
                emissionFactor: parseFloat(row.emissionFactor) || 0,
                co2Emissions: parseFloat(row.co2Emissions) || 0,
                subCategory: row.subCategory
              });
              break;
          }
        });

        // Daten für Dashboard vorbereiten
        const dashboardData = {
          companyInfo: {
            name: results.data[0]?.companyName || "Unbekannte Firma",
            year: results.data[0]?.year || new Date().getFullYear(),
            date: new Date().toISOString()
          },
          scope1: scope1Data
        };

        // Daten im localStorage speichern
        localStorage.setItem('co2Data', JSON.stringify(dashboardData));

        // Summen berechnen
        const scope1Total = {
          vehicles: calculateTotal(scope1Data.vehicles),
          transport: calculateTotal(scope1Data.transport1B),
          heating: calculateTotal(scope1Data.scope1C),
          techGases: calculateTotal(scope1Data.scope1D),
          other: calculateTotal(scope1Data.scope1DOther)
        };

        // Dashboard anzeigen
        showDashboard(scope1Total, dashboardData.companyInfo);

        // Optional: Zur Dashboard-Seite navigieren
        window.location.href = 'Dashboard.html';
      }
    });
  }

  function calculateTotal(items) {
    return items.reduce((sum, item) => {
      if (item.co2Emissions) {
        return sum + parseFloat(item.co2Emissions);
      }
      return sum + (parseFloat(item.quantity) * parseFloat(item.emissionFactor) || 0);
    }, 0);
  }

  function showDashboard(scope1Total, companyInfo) {
    const dashboard = document.getElementById('dashboard');
    dashboard.style.display = 'block';

    // Gesamtsumme Scope 1
    const totalScope1 = Object.values(scope1Total).reduce((a, b) => a + b, 0);

    // Dashboard HTML aktualisieren
    const scopeSummaryEl = document.getElementById('scopeSummary');
    scopeSummaryEl.innerHTML = `
      <div class="scope-box">
        <h3>Scope 1A - Fahrzeuge</h3>
        <p>${scope1Total.vehicles.toFixed(2)} kg CO₂</p>
      </div>
      <div class="scope-box">
        <h3>Scope 1B - Transport</h3>
        <p>${scope1Total.transport.toFixed(2)} kg CO₂</p>
      </div>
      <div class="scope-box">
        <h3>Scope 1C - Heizung</h3>
        <p>${scope1Total.heating.toFixed(2)} kg CO₂</p>
      </div>
      <div class="scope-box">
        <h3>Scope 1D - Technische Gase</h3>
        <p>${scope1Total.techGases.toFixed(2)} kg CO₂</p>
      </div>
      <div class="scope-box">
        <h3>Scope 1E - Sonstige</h3>
        <p>${scope1Total.other.toFixed(2)} kg CO₂</p>
      </div>
      <div class="scope-box" style="background: #e3f2fd;">
        <h3>Scope 1 Gesamt</h3>
        <p>${totalScope1.toFixed(2)} kg CO₂</p>
      </div>
    `;

    // Diagramm erstellen
    createDetailedScope1Chart(scope1Total);
  }

  function createDetailedScope1Chart(scope1Total) {
    const ctx = document.getElementById('scopeChart').getContext('2d');
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Fahrzeuge', 'Transport', 'Heizung', 'Technische Gase', 'Sonstige'],
        datasets: [{
          data: [
            scope1Total.vehicles,
            scope1Total.transport,
            scope1Total.heating,
            scope1Total.techGases,
            scope1Total.other
          ],
          backgroundColor: [
            'rgba(54,162,235,0.7)',
            'rgba(255,99,132,0.7)',
            'rgba(75,192,192,0.7)',
            'rgba(153,102,255,0.7)',
            'rgba(255,159,64,0.7)'
          ]
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom' },
          title: {
            display: true,
            text: 'Scope 1 Emissionen Verteilung'
          }
        }
      }
    });
  }

  /* ####################################################################
   * (C) CSV-Vorschau (Debug)
   * #################################################################### */
  function showCSVPreview(data) {
    const previewEl = document.getElementById('csvPreview');
    previewEl.innerHTML = '';
    if (!data || data.length === 0) {
      previewEl.innerHTML = '<p class="info-msg">Keine Daten oder leere CSV.</p>';
      return;
    }
    let tableHTML = '<table id="csvPreviewTable"><thead><tr>';
    const columns = Object.keys(data[0]);
    columns.forEach(col => { tableHTML += `<th>${col}</th>`; });
    tableHTML += '</tr></thead><tbody>';

    // Nur die ersten 15 Zeilen
    data.slice(0, 15).forEach(row => {
      tableHTML += '<tr>';
      columns.forEach(col => {
        tableHTML += `<td>${row[col]||''}</td>`;
      });
      tableHTML += '</tr>';
    });
    tableHTML += '</tbody></table>';
    previewEl.innerHTML = tableHTML;
  }

  /* ####################################################################
   * (D) Dashboard-Logik & Diagramme
   * #################################################################### */
  function sumEmissions(arr, key="co2Emissions") {
    let sum = 0;
    arr.forEach(obj => {
      let val = parseFloat(obj[key]) || 0;
      // Falls co2Emissions leer, rechne: emissionFactor * quantity
      if (val === 0 && obj.emissionFactor && obj.quantity) {
        val = parseFloat(obj.emissionFactor) * parseFloat(obj.quantity) || 0;
      }
      sum += val;
    });
    return sum;
  }

  function getScopeLabel(scopeCode) {
    if (!scopeCode || scopeCode.length === 0) return "Unbekannt";
    const main = scopeCode.charAt(0);
    if (main === '1') return "Scope 1";
    if (main === '2') return "Scope 2";
    if (main === '3') return "Scope 3";
    return "Unbekannt";
  }

  function generateDashboard(data) {
    if (!data || data.length === 0) return;
    document.getElementById('dashboard').style.display = 'block';

    // (1) Firmeninfo
    let companyName = "Unbekannte Firma";
    let year = "???";
    for (let i=0; i<data.length; i++) {
      if (data[i].companyName && data[i].year) {
        companyName = data[i].companyName;
        year = data[i].year;
        break;
      }
    }
    const infoEl = document.getElementById('companyInfo');
    infoEl.textContent = `Firma: ${companyName}, Bezugsjahr: ${year} (Datensätze: ${data.length})`;

    // (2) Gruppierung nach scope
    const scopeGroups = {};
    data.forEach(row => {
      let sc = (row.scope || '').toString().trim();
      if (sc === '3B' && row.subCategory) {
        sc += '_' + row.subCategory.trim().toLowerCase();
      }
      if (!scopeGroups[sc]) scopeGroups[sc] = [];
      scopeGroups[sc].push(row);
    });

    // (3) Summen pro Scope
    const scopeSums = { "Scope 1": 0, "Scope 2": 0, "Scope 3": 0 };
    const subScopeSums = {};

    for (let scCode in scopeGroups) {
      const subSum = sumEmissions(scopeGroups[scCode], "co2Emissions");
      subScopeSums[scCode] = subSum;
      const mainLabel = getScopeLabel(scCode);
      scopeSums[mainLabel] += subSum;
    }
    const total = scopeSums["Scope 1"] + scopeSums["Scope 2"] + scopeSums["Scope 3"];

    // (4) Kleine Boxen pro Scope
    const scopeSummaryEl = document.getElementById('scopeSummary');
    scopeSummaryEl.innerHTML = `
      <div class="scope-box">
        <h3>Scope 1</h3>
        <p>${scopeSums["Scope 1"].toFixed(2)} kg CO₂</p>
      </div>
      <div class="scope-box">
        <h3>Scope 2</h3>
        <p>${scopeSums["Scope 2"].toFixed(2)} kg CO₂</p>
      </div>
      <div class="scope-box">
        <h3>Scope 3</h3>
        <p>${scopeSums["Scope 3"].toFixed(2)} kg CO₂</p>
      </div>
    `;

    // (5) Tabelle
    const scopeTableBody = document.querySelector('#scopeTable tbody');
    scopeTableBody.innerHTML = '';
    ["Scope 1","Scope 2","Scope 3"].forEach(scope => {
      const val = scopeSums[scope];
      const perc = (total>0) ? (val/total*100).toFixed(1) : 0;
      scopeTableBody.innerHTML += `
        <tr>
          <td>${scope}</td>
          <td>${val.toFixed(2)}</td>
          <td>${perc}%</td>
        </tr>
      `;
    });
    document.getElementById('totalEmissionCell').textContent = total.toFixed(2);

    // (6) Diagramme
    createScopeChart(scopeSums);
    const subLabels = [];
    const subValues = [];
    for (let ssc in subScopeSums) {
      subLabels.push(ssc);
      subValues.push(subScopeSums[ssc]);
    }
    createSubscopeChart(subLabels, subValues);
  }

  /* Diagramm: Doughnut (Scopes) */
  let scopeChartRef = null;
  function createScopeChart(scopeSums) {
    const ctx = document.getElementById('scopeChart').getContext('2d');
    if (scopeChartRef) scopeChartRef.destroy();
    const s1 = scopeSums["Scope 1"]||0;
    const s2 = scopeSums["Scope 2"]||0;
    const s3 = scopeSums["Scope 3"]||0;

    scopeChartRef = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Scope 1', 'Scope 2', 'Scope 3'],
        datasets: [{
          data: [s1, s2, s3],
          backgroundColor: [
            'rgba(54,162,235,0.7)',
            'rgba(255,99,132,0.7)',
            'rgba(75,192,192,0.7)'
          ]
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom' }
        }
      }
    });
  }

  /* Diagramm: Balkendiagramm (Subscopes) */
  let subscopeChartRef = null;
  function createSubscopeChart(labels, values) {
    const ctx = document.getElementById('subscopeChart').getContext('2d');
    if (subscopeChartRef) subscopeChartRef.destroy();
    subscopeChartRef = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'CO₂ (kg)',
          data: values,
          backgroundColor: 'rgba(153,102,255,0.7)'
        }]
      },
      options: {
        responsive: true,
        indexAxis: 'x',
        plugins: {
          legend: { display: false }
        },
        scales: {
          x: { ticks: { autoSkip: false, maxRotation: 45, minRotation: 0 } },
          y: { beginAtZero: true }
        }
      }
    });
  }

  /* ####################################################################
   * (E) PDF-Export (html2pdf)
   * #################################################################### */
  function downloadPDF() {
    const element = document.getElementById('pdfContent');
    const opt = {
      filename: 'CO2_Express_Bilanz.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 3 },
      jsPDF: { unit: 'pt', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().from(element).set(opt).save();
  }

  /* ####################################################################
   * (F) Excel-Export (SheetJS)
   * #################################################################### */
  function downloadExcel() {
    if (!parsedData || parsedData.length===0) {
      alert('Keine Daten vorhanden.');
      return;
    }

    const wb = XLSX.utils.book_new();
    wb.Props = {
      Title: "CO2 Express Bilanz",
      Subject: "CO2 Bilanz",
      Author: "CO2 Express",
      CreatedDate: new Date()
    };

    // 1) Rohdaten
    const rawDataSheet = XLSX.utils.json_to_sheet(parsedData);
    XLSX.utils.book_append_sheet(wb, rawDataSheet, "Rohdaten");

    // 2) Summen pro Scope
    const scopeGroups = {};
    parsedData.forEach(row => {
      let sc = (row.scope || '').toString().trim();
      if (sc==='3B' && row.subCategory) {
        sc += '_'+row.subCategory.trim().toLowerCase();
      }
      if (!scopeGroups[sc]) scopeGroups[sc] = [];
      scopeGroups[sc].push(row);
    });

    const scopeSums = { "Scope 1":0, "Scope 2":0, "Scope 3":0 };
    const subScopeSums = {};
    for (let scCode in scopeGroups) {
      const sumVal = sumEmissions(scopeGroups[scCode]);
      subScopeSums[scCode] = sumVal;
      const mainScope = getScopeLabel(scCode);
      scopeSums[mainScope] += sumVal;
    }
    const total = scopeSums["Scope 1"] + scopeSums["Scope 2"] + scopeSums["Scope 3"];

    // 3) Worksheet: Summen
    const sumSheetData = [
      ["Scope","CO2 (kg)","Anteil (%)"],
      ["Scope 1", scopeSums["Scope 1"], (scopeSums["Scope 1"]/total*100).toFixed(1)],
      ["Scope 2", scopeSums["Scope 2"], (scopeSums["Scope 2"]/total*100).toFixed(1)],
      ["Scope 3", scopeSums["Scope 3"], (scopeSums["Scope 3"]/total*100).toFixed(1)],
      ["Gesamt", total, "100%"]
    ];
    const sumSheet = XLSX.utils.aoa_to_sheet(sumSheetData);
    XLSX.utils.book_append_sheet(wb, sumSheet, "Scope_Summen");

    // 4) Worksheet: Subscope-Details
    const subSheetData = [["Subscope","CO2 (kg)"]];
    for (let ssc in subScopeSums) {
      subSheetData.push([ssc, subScopeSums[ssc]]);
    }
    const subSheet = XLSX.utils.aoa_to_sheet(subSheetData);
    XLSX.utils.book_append_sheet(wb, subSheet, "Subscope_Details");

    // 5) Speichern
    XLSX.writeFile(wb, "CO2_Express_Bilanz.xlsx");
  }
  /**
 * Zusätzliche Dictionarys für Standardwerte (z. B. verschiedene Kraftstoffe).
 * Du kannst beliebig viele Dictionarys anlegen und in sumEmissions() darauf zugreifen.
 */
const DEFAULT_FUEL_FACTORS = {
  // Beispiele: kg CO2 pro Liter
  "Diesel": 2.65,
  "Benzin": 2.32,
  "Biodiesel": 1.84
};

// Du kannst dein sumEmissions() anpassen, um bei passender activityName (z. B. "Firmen-PKW Diesel")
// oder unit "Liter" -> Diesel fallback zu ziehen. Beispiel:
function sumEmissionsWithFuelFallback(arr, co2Key = "co2Emissions") {
  let sum = 0;
  arr.forEach(obj => {
    let val = parseFloat(obj[co2Key]) || 0;

    // 1) Falls co2Emissions leer
    if (val === 0) {
      let factor = parseFloat(obj.emissionFactor) || 0;
      let qty = parseFloat(obj.quantity) || 0;

      // 2) Falls emissionFactor nicht da -> Kraftstoff- oder Einheiten-Fallback
      if (factor === 0) {
        // z. B. Prüfung auf activityName: "Firmen-PKW Diesel", "Firmen-PKW Benzin", ...
        if (obj.activityName && DEFAULT_FUEL_FACTORS[obj.activityName.split(" ").pop()]) {
          // "Firmen-PKW Diesel" => letztes Wort "Diesel"
          let lastWord = obj.activityName.split(" ").pop(); 
          factor = DEFAULT_FUEL_FACTORS[lastWord] || 0;
        }
      }

      // 3) Multiplikation
      val = factor * qty;
    }
    sum += val;
  });
  return sum;
}
/**
 * toggleSubscopeChartType:
 *  - Wechselt den Chart-Type zwischen 'bar' und 'line'.
 */
 function toggleSubscopeChartType() {
  if (!subscopeChartRef) return;
  // subscopeChartRef.config.type -> 'bar' oder 'line'
  const currentType = subscopeChartRef.config.type;
  subscopeChartRef.destroy(); // Altes Chart zerstören

  // Neues Chart anlegen, toggeln
  const newType = (currentType === 'bar') ? 'line' : 'bar';
  subscopeChartRef = new Chart(document.getElementById('subscopeChart').getContext('2d'), {
    type: newType,
    data: {
      labels: subscopeChartRef.config.data.labels,
      datasets: subscopeChartRef.config.data.datasets
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { autoSkip: false, maxRotation: 45, minRotation: 0 } },
        y: { beginAtZero: true }
      }
    }
  });
}

  </script>
</body>
</html>